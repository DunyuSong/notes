# 接口自动化框架方案设计
## 背景
1. 业务线发展、扩张。接口越来越庞大难以管理与回归。GameLife、5866商城、租号...
2. 测试效率提升。在已经有接口文档的前提下，当开发提测后，如何能在8小时内完成第一轮接口测试，并输出报告...

## 现状分析
目前接口测试存在的问题
1. 工具多、杂。PostMan、swagger、JMeter、Python、Java...
2. 学习成本高。
3. 团队协作难。文档统一管理、变更通知...
4. 维护成本高。用例编写方式不统一、工具调试麻烦、复用性不高
5. 现有工具难以与公司平台很好的结合。

## 目标
- 提高ROI（Return On Investment，投资回报率）
### 减少投入
1. 工具开发成本。使用公司已有或成熟开源框架。
2. 学习成本。统一化操作流，简单易于学习，无需编码基础有可以做接口测试。
3. 脚本维护成本。
4. 测试用例管理、维护。
### 增加收益
1. 可持续的自动化测试。
2. 辅助业务测试。造数据、模拟场景前提条件、后置条件、管理业务用例（比如有些用例是通过代码(python,java,c++)编写的，可以放到平台做管理，或者后续开发的功能测试用例可以与接口测试平台关联，比如WebUi自动化+抓包自动跑接口测试？）
3. 用例的复用性。用例组装测试。
4. 增加工具使用率。
5. 可扩展性。与性能测试、安全测试结合？？？

## 方案设计
- 如何快速实现从0到1？
- 如何减少学习成本？
- 如何实现协作管理？

### 如何快速实现从0到1？
充分利用开源社区成熟项目提高工具开发速度与质量。
- 用例编写：使用JSON编写测试用例。JSON Schema校验用例格式。JSONPath提取JSON数据。
- 用例配置: TestNG。执行顺序、是否执行、执行次数、依赖关系、群组管理、断言等。
- 发送请求：HTTPClient/REST Assured。发送请求、获取响应结果。
- 用例运行: TestNG XML、Jenkins API Client、Quartz。（TestNG原生xml方式运行测试用例、Jenkins开放API自动创建job、Quartz定时任务模块）
- 用例管理：TestNG + Spring MVC + JDBC/MyBatis + MySQl。增删改查、数据统计、测试报告。

### 如何减少学习成本？
通用、易扩展、模块化
- 通用：统一化用例编写方式，数据与脚本分离，便于维护。
- 易扩展：支持多样化格式用例，可转换为平台统一数据协议。
- 模块化：专人维护、减少多团队间的重复开发工作。有更好的平台，可快速迁移。

### 如何实现协作管理？
- 平台化存储接口文档
- 平台化存储接口用例
- 平台化管理项目、人员

## 接口平台设计
功能模块参考“接口自动化平台.xmind”。

### 公共模块
- 公共模块主要为管理功能（增删改查），初步想法是以下功能：统一登录、权限认证、项目管理、用户管理、环境管理、接口管理、报告管理、日志系统、数据统计、开放API、数据库设计、定时任务、缓存机制等。
> 公共模块建议寻求开发资源，每个项目基本都会有这些公共模块，可以借助公司其他项目集成进来。

### 核心模块
- 流程：接口定义-->[mock测试]-->接口测试-->场景测试-->回归测试-->测试报告
- 接口定义：接口文档编写、文档历史、变更通知(变更自动触发测试？)、接口导入（postman、swagger、Excel、xml等）
- Mock测试：接口调试服务，可独立于接口自动化平台。
- 接口测试：用例编写、打标签、参数化、复制、断言、分组、依赖关系。
- 场景测试：组装单个接口、接口之间传参处理。
- 回归测试：组装场景接口、定时触发回归测试。
- 测试报告：HTML、Excel。
- 通知中心：E-mail、企业微信。
- 环境配置：Dev、QA、Online...
- 参数配置：全局参数变量、项目参数变量、测试用例变量传递。
- 触发机制：手动、定时、远程调用(通过生成一个加密URL方式可远程触发调用执行测试)。
- 签名校验。可以针对每一个接口配置一个模板，将其中与业务功能无关的参数以及技术细节封装起来，例如签名校验、时间戳、随机值等，而与业务功能相关的参数配置为可传参的模式。

#### 测试用例与平台分离
- 采用更加通用抽离化方式JSON统一存储，使用例更加通用、抽象化。便于第三方导入，比如Excel、postman、swagger、xml等。数据结构体参考"接口自动化测试用例设计.md",
- 优化：通过对象生成测试用例。

#### 接口自动化框架
- Java + HttpClient/Rest-Assured + Maven + TestNG + Spring MVC + JDBC/MyBatis + MySQL + log4j **
- Java: 使用Java作为框架的开发语言
- HttpClient：作为接口自动化底层框架，用于发送请求。也会考虑使用 Rest-Assured 来做，Rest-Assured 会使测试用例更加简洁(数据提取、断言)。协议层需要抽象封装一层，用于后续的切换。
- Maven： 负责项目的编译、打包、jar包管理等。
- TestNG: 接口自动化运行框架，执行测试用例、配置用例、组装测试用例、处理依赖关系、生成测试报告。
- Spring MVC: 服务端项目框架。
- JDBC: 数据库交互。也会考虑使用 MyBatis来实现。
- MySQL: 数据持久化。存储平台上所有数据。
- log4j: 日志系统。
- Jenkins： 使用Jenkins API 远程创建Job，执行测试。（也可能不用这个）
- ![](http://cloudnotes.nos-eastchina1.126.net/20190429024212-496266.jpg)
#### 数据库表设计
MySQL存储数据，表设计参考“接口自动化平台.xmind”。

## 框架概要设计
### 框架最初构想图
![](http://cloudnotes.nos-eastchina1.126.net/20190424033401-426441.jpg)

### 框架模块设计
- 框架模块划分<br/>
![](http://cloudnotes.nos-eastchina1.126.net/20190424033619-102327.jpg)
- 框架五大“神器”之间分工合作，就像乐高积木一样，各个模块完成自己的工作，组装起来就是一个强大的系统
![](http://cloudnotes.nos-eastchina1.126.net/20190424033844-326874.jpg)

#### 转换器
![](http://cloudnotes.nos-eastchina1.126.net/20190424035933-561768.png)
- 待优化：用例每次修改都需要重新生成JSON文件--解析--生成.java，可能会性能会比较差。
1. 判断是否是新增用例，如果新增则走全流程。然后将JOSN文件拆分字段存储到DB中（将经常需求修改的字段单独存放）
2. 如果是修改用例，更新数据库--重新生成.java文件（可能会有问题，因为需要用例有些数据在解析过程中需要做函数处理？？？？？？

### 解析器
![](http://cloudnotes.nos-eastchina1.126.net/20190424044341-469803.png)

### 运行器
![](http://cloudnotes.nos-eastchina1.126.net/20190424044438-660373.png)

### 报告生成器
![](http://cloudnotes.nos-eastchina1.126.net/20190424044523-855152.png)

## 问题与风险
### 已知问题
- [ ] 不同环境，不同机器上，访问不同数据库之间如何配置调用。
- [ ] 如何支持自定义签名，Java代码执行。
    - 方案1：通过关键字自定义扩展。
    - 方案2：通过热加载java代码是否可以实现？但是加载的包必须项目中存在才可以，否则还是会存在找不到包。
- [ ] 数据驱动如何动态获取。
    - 方案1：测试用例直接包含，使用数组实现单值传递；
    - 方案2：通过@DataProvider延迟加载？？？。
- [ ] 测试任务的执行。
    - 1. Maven 命令执行
    - 2. Jenkins API
    - 3. Quartz
- [ ] Java如何实现加载自己写的方法？
    - 1. 在项目目录下定义一个“CustomKeyword.java”类文件，用于加载用户自定义的方法。
    - 2. 通过反射读取CustomKeyword类中的方法名称作为关键字。
    - 3. 当框架启动时加载CustomKeyword类中，读取所有方法名称作为关键字。
    - 4. CustomKeyword类中的方法名称作为变量名称，值为方法的返回值，如果方法无返回值则返回null。
    - 5. 如果用户使用了JDK之外的包如何处理？安全性如何保障？
        - 1. 让用户先添加pom依赖。研究一下maven中导入其他pom.xml文件中的依赖包。
        - 2. 提交需要的pom依赖名称，人工添加到依赖包中。

### 潜在问题

## 待研究
#### java代码动态生成
- [借助 javassist 动态生成测试类]https://testerhome.com/topics/18811 
- [ ] [接口测试][TestNG] 基于 testNG 的并发测试 (https://testerhome.com/topics/17534)
- [ ] 使用 java 动态加载机制模拟脚本语言的效果(https://testerhome.com/topics/9040)


#### 用例变量、参数化
- [接口测试平台一期] 接口测试用例参数、变量方案(https://testerhome.com/topics/11372)

#### 数据库表结构
- [接口测试平台二期] 接口测试服务之建表（https://testerhome.com/topics/11908）

#### 测试用例运行
- 可以使用Jenkins：https://github.com/jenkinsci/java-client-api
- [Jenkins RESTful API 定制化]https://testerhome.com/topics/6057
- [接口测试平台二期] Jenkins 远程创建 job 及构建(https://testerhome.com/topics/12930)

