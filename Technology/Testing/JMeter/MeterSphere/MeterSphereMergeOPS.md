# MeterSphere整合OPS方案

## OPS与MS对应关系

-   OPS---user.name		--------> 	MS---user.id
-   OPS---project.name   ------->      MS---workspace.name。工作空间管理。增删改查、及人员与工作空间关联。

-   OPS---权限管理   -------> MS---role.test_manager。权限管理（测试经理：可对接口测试、性能测试进行所有操作。）

## 方案一 Cookies + API Keys

- 分为两类：涉及到用户新增、工作空间新增、修改工作空间时使用admin的帐号用API Keys进行OPS与MS交互。其余操作使用当前登入的用户id进行操作，比如新增项目、查看接口列表、执行测试、查看报告、添加用例等。
- 用户数据迁移：第一次要批量将OPS目前现在存在用户调用MS接口循环创建一次，否则可能会出现用户关联工作空间时找不到用户的情况。可以使用postman循环创建所有用户。
- 接口返回值统一说明：{"success": true},  true表示成功,false失败。
- 默认组织id、默认工作空间ID、角色ID：系统初始化会创建可以写死全局值，其他值根据实际情况传入。
- 接口数据符号说明：{{}}里面的值为动态生成
### 交互流程
1. OPS用户登入后使用OPS的user.name + 统一密码Autotest#123调用MS登入接口“/signin”判断用户是否存在,如果不存在则使用Admin的API Keys 调用新增用户接口“/user/special/add”，创建一个“只读用户、默认工作空间”的用户。

- 用户_登入接口：POST {{URL}}/signin
```java
{
    "username":"dd.shan8",
    "password":"Autotest#123"
}
```

- 用户_新增-只读用户-默认工作空间： POST {{URL}}/user/special/add
```java
{
    "id": "{{id}}",
    "name": "{{name}}",
    "email": "{{email}}",
    "phone": "15606690056",
    "password": "Autotest#123",
    "roles": [
        {
            "id": "test_viewer",
            "ids": [
                "8c8f13c0-3852-11eb-a44c-005056b431aa"
            ]
        }
    ],
    "orgList": [
        {
            "id": "8c8ecd5b-3852-11eb-a44c-005056b431aa",
            "name": "默认组织",
            "description": "系统默认创建的组织"
        }
    ],
    "wsList": [
        {
            "id": "8c8f13c0-3852-11eb-a44c-005056b431aa",
            "organizationId": "8c8ecd5b-3852-11eb-a44c-005056b431aa",
            "name": "默认工作空间",
            "description": "系统默认创建的工作空间"
        }
    ]
}
```
- 说明：roles.ides=工作空间ID。orgList.id=组织ID。wsList.id=工作空间ID。wsList.oranizationId=组织Id

2.  OPS用户创建项目时使用Admin的API Keys 调用MS接口“/workspace/special/add” 主动创建MS的工作空间，并将工作空间Id保存到OPS库中的third_ms表中。

    -   工作空间_添加：POST {{URL}}/workspace/special/add

        ```java
        {
            "organizationId": "8c8ecd5b-3852-11eb-a44c-005056b431aa",
            "name": "{{name}}",
            "description": "{{name}}"
        }
        ```

    -   表结构（待定）

        -   | ops_project_name | ops_project_status | ms_workspace_name | ms_workspace_id    | ms_user_id     |
            | ---------------- | ------------------ | ----------------- | ------------------ | -------------- |
            | OA项目           | 0                  | OA项目12345678901 | xxxxxxx            | dd.shan        |
            | 项目名称唯一     |                    | 工作空间名称唯一  | 工作空间id不可修改 | 用户id不可修改 |
            |                  |                    |                   |                    |                |

        

3.   OPS用户在项目管理中关联用户到项目时调用MS Admin Keys 进行用户与工作空间的绑定。通过查询third_ms.ops_project_name查询到工作空间ID，进行工作空间用户的关联，角色默认。

    -   工作空间_添加成员到此工作空间：POST {{URL}}/user/special/ws/member/add

        ```java
        {
            "userIds": [
                "dd.shan8","dd.shan7","动态传入"
            ],
            "roleIds": [
                "test_manager"
            ],
            "workspaceId": "adff05ea-5f79-4123-9736-77fc4b61dc06动态传入"
        }
        ```

4.  OPS项目删除、项目名称修改时需要同步调用MS的Admin Keys 进行更新，并写更新third_ms表中的子段值。

    -   工作空间_删除： GET  {{URL}}/workspace/special/delete/:workspaceId

    -   工作空间_更新：POST {{URL}}/workspace/special/update

        ```java
        {
            "id": "e4bdb1a9-2282-4f52-848f-266b611ef7ab动态传入",
            "name": "更新之后的值动态传入",
            "organizationId": "8c8ecd5b-3852-11eb-a44c-005056b431aa"
        }
        ```

        

5.  OPS点击接口测试后使用OPS中user.name+默认密码进行登入MS,拿到MS返回的Cookies值，保存下来。然后通过third.ms表查询出此项目的workspaceId，在调用切换工作空间接口“{{URL}}/user/switch/source/ws/{workspaceId}“之后开始加载接口测试页面。

    -   工作空间切换： GET {{URL}}/user/switch/source/ws/:workspaceId

## 接口信息导入
- OPS中的接口信息导入到MS中的接口定义，格式为Postman Collection V2.1格式结构，参数如下格式：
- 格式说明：支持json、form-data两种格式，text、file暂不做兼容。item数组中保存了每个接口所需要的信息，event节点为脚本暂不做支持。**需要注意：节点为数组[]的时候需要将全部值导入**
```json
{
	"info": {
		"_postman_id": "eb38c5e8-1212-4612-bded-699a7550cd46",
		"name": "OPS导出格式说明",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "GET请求例子-这是接口名称",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"pm.environment.set(\"variable_key\", \"这里的脚本就不用导入拉\");"
						],
						"type": "text/javascript"
					}
				}
			],
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"warning": "This is a duplicate header and will be overridden by the Content-Type header generated by Postman.",
						"key": "Content-Type",
						"value": "application/json",
						"description": "这里是请求头数据",
						"type": "text"
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": [
						{
							"key": "body1",
							"value": "test",
							"description": "这是一个Get请求携带form-data数据的请求",
							"type": "text"
						},
						{
							"key": "body2",
							"value": "aaa",
							"description": "这是一个Get请求携带form-data数据的请求",
							"type": "text"
						},
						{
							"key": "body2",
							"value": "aaa",
							"description": "这是一个Get请求携带form-data数据的请求",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "/sworg_service/findAllUser.do?reqJson=${get_req_json(findAllUser)}&siteId=${get_site_id()}&time=${get_time()}&sign=${get_sign()}",
					"path": [
						"sworg_service",
						"findAllUser.do"
					],
					"query": [
						{
							"key": "reqJson",
							"value": "${get_req_json(findAllUser)}"
						},
						{
							"key": "siteId",
							"value": "${get_site_id()}"
						},
						{
							"key": "time",
							"value": "${get_time()}"
						},
						{
							"key": "sign",
							"value": "${get_sign()}"
						}
					]
				},
				"description": "这是接口描述"
			},
			"response": []
		},
		{
			"name": "POST请求例子-JSON数据格式",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n\t\"username\":\"sys.sw\",\n\t\"password\":\"RWh55E/9ZKCd4Sg8RsgdfbOaek7Ym3Fv7vjna0u7e/6l7WEh64bcvAEtZt+/tOzaTXgZYCnxIKwCxaSyDWg8qL7Cylv6xoTD3tkxOpCz5/KdPczsFltxDaKQ9AGsGnGOoHDwS7c7xFvowcMZv+LsAyMSUWQke/TzW/4ojdTUDgw=\",\n\t\"remember\":true\n}"
				},
				"url": {
					"raw": "/files/upload.htm?siteId=$siteId&memberId=$memberId&directory=$directory&file=$file&time=$time&sign=${get_sign()}&signVersion=$signVersion",
					"path": [
						"files",
						"upload.htm"
					],
					"query": [
						{
							"key": "siteId",
							"value": "$siteId"
						},
						{
							"key": "memberId",
							"value": "$memberId"
						},
						{
							"key": "directory",
							"value": "$directory"
						},
						{
							"key": "file",
							"value": "$file"
						},
						{
							"key": "time",
							"value": "$time"
						},
						{
							"key": "sign",
							"value": "${get_sign()}"
						},
						{
							"key": "signVersion",
							"value": "$signVersion"
						}
					]
				},
				"description": "这是一个POST请求，数据为JSON格式"
			},
			"response": []
		},
		{
			"name": "POST请求例子-form-data数据格式",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": [
						{
							"key": "aa",
							"value": "bb",
							"description": "这是一个POST请求携带form-data数据的请求",
							"type": "text"
						},
						{
							"key": "cc",
							"value": "dd",
							"description": "这是一个POST请求携带form-data数据的请求",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "/files/upload.htm?siteId=$siteId&memberId=$memberId&directory=$directory&file=$file&time=$time&sign=${get_sign()}&signVersion=$signVersion",
					"path": [
						"files",
						"upload.htm"
					],
					"query": [
						{
							"key": "siteId",
							"value": "$siteId"
						},
						{
							"key": "memberId",
							"value": "$memberId"
						},
						{
							"key": "directory",
							"value": "$directory"
						},
						{
							"key": "file",
							"value": "$file"
						},
						{
							"key": "time",
							"value": "$time"
						},
						{
							"key": "sign",
							"value": "${get_sign()}"
						},
						{
							"key": "signVersion",
							"value": "$signVersion"
						}
					]
				},
				"description": "这是一个POST请求，数据为JSON格式"
			},
			"response": []
		}
	]
}
```

## 部署方式
### Front
1. 前端可单独构建部署，使用nginx。

2. 配置如下：

   ```
   user root root;
   worker_processes 6;
   
   error_log  /data/nginx_log/error.log  crit;
   
   
   events {
       use  epoll;
       worker_connections  65535;
   }
   
   
   http {
       include       mime.types;
       default_type  application/octet-stream;
       log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
       access_log   /data/nginx_log/access.log  main;
   
       charset  utf-8;
       server_names_hash_bucket_size 128;
       client_header_buffer_size 32k;
       large_client_header_buffers 4 32k;
   
       sendfile       on;
       tcp_nopush     on;
       tcp_nodelay    on;
       keepalive_timeout  60;
   
       upstream ms_server {
       #ip_hash;
       server   192.168.163.41:8081  max_fails=2 fail_timeout=30s;
       }
   
       server {
   
       server_names_hash_bucket_size 128;
       client_header_buffer_size 32k;
       large_client_header_buffers 4 32k;
   
       sendfile       on;
       tcp_nopush     on;
       tcp_nodelay    on;
       keepalive_timeout  60;
   
       upstream ms_server {
       #ip_hash;
       server   192.168.163.41:8081  max_fails=2 fail_timeout=30s;
       }
   
       server {
           listen       80;
           server_name  ms.xxx.com;
           index  index.html index.htm;
           #root   /data/www;
   
            location / {
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
   
               add_header Last-Modified $date_gmt;
               add_header Cache-Control no-cache;
               expires -1;
               root /data/meter;
               index  index.html index.htm;
               #try_files $uri $uri/ /index.html ;
               #error_page 404 /index.html;
           }
           location ~ /(meter|performance|api|socket) {
               proxy_http_version 1.1;
               proxy_set_header Host  $host;
               proxy_set_header X-Real-Ip $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Nginx-Proxy true;
               #proxy_redirect off;
               client_max_body_size 10m;
               rewrite ^/meter/(.*)$ /$1 break;
               proxy_pass http://ms_server;
               # websocket
               proxy_set_header Upgrade $http_upgrade;
               proxy_set_header Connection "upgrade";
               proxy_connect_timeout 300s;
               proxy_read_timeout 300s;
               proxy_send_timeout 300s;
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, projectid';
               add_header 'Access-Control-Allow-Methods' 'POST, GET, PUT, DELETE, OPTIONS';
           }
           # websocket
           location = /meter/signin {
           #rewrite ^/signin http://192.168.173.134:9032/v1/project/abcd;
               proxy_pass http://192.168.9.82:9032/v1/project/signin;
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, projectid';
               add_header 'Access-Control-Allow-Methods' 'POST, GET, PUT, DELETE, OPTIONS';
   
       }
   }
   }
   
   ```

   
### Server
1. 使用docker容器替换方案，首先将修改的代码使用maven打包成jar包。执行:mvn clean package

2. 修改容器的jar包名称：

   ```bash
   docker exec -it 1711dc027b05 /bin/sh
   mv /opt/apps/backend-1.6.jar /opt/apps/backend-1.6.jar.backup
   exit
   docker cp  /tmp/backend-1.6.jar 1711dc027b05:/opt/apps/backend-1.6.jar
   ```
3. 重启服务：msctl restart

## 疑问

1. MS的登入如果开启配置文件中的run.mode=local则不需要做密码验证。暂不清楚是否有其他影响。
2. MS登入成功之后与系统的交互是保存的在cookie中的，那OPS如何拿到cookie与MS进行API的交互呢？
3. 